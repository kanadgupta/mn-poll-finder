{{!-- DO NOT LET PRETTIER REMOVE THIS --}}
<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8' />
    <link rel='icon' href='https://fav.farm/üó≥Ô∏è' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />

    <title>{{seo.title}}</title>

    <!-- Meta tags for SEO and social sharing -->
    <link rel='canonical' href='{{seo.url}}' />
    <meta name='description' content='{{seo.description}}' />
    <meta property='og:title' content='{{seo.title}}' />
    <meta property='og:type' content='article' />
    <meta property='og:url' content='{{seo.url}}' />
    <meta property='og:description' content='{{seo.description}}' />
    <meta name='twitter:card' content='summary' />

    <!-- Import the webpage's stylesheet -->
    <link rel='stylesheet' href='/style.css' />
  </head>
  <body>
    <div class='wrapper'>
      <div class='content' role='main'>

        <!-- This is the start of content for our page -->
        <h1 class='title'><a class='title' href='/'>MPLS 2021 Poll Finder</a></h1>

        <!-- Add text indicating that we've found the precinct OR had an error -->
        {{#if precinct}}
          {{#if mplsPollingPlace21.address}}
            <p class='precinct-info'>
              The polling place for
              <a href='{{gmaps}}' id='address' rel='noopener' target='_blank'>{{address}}</a>
              is...<br /><br />
              üó≥Ô∏è
              <a href='{{mplsPollingPlace21.gmapsUrl}}' id='mplsPollingPlace21' rel='noopener' target='_blank'><span
                  id='mplsPollingPlace21-name'
                >{{mplsPollingPlace21.building}}</span>
                -
                <span id='mplsPollingPlace21-address'>{{mplsPollingPlace21.address}}</span></a>
              {{#if mplsPollingPlace21.directions}}
                <br />
                <span class='directions precinct-info'>üö™ (<span
                    id='mplsPollingPlace21-name'
                  >{{mplsPollingPlace21.directions}}</span>)</span>
              {{/if}}
            </p>
            <p class='precinct-info'>... but that info is for Election Day (Nov 2nd).
              <b>You should
                <a
                  href='https://vote.minneapolismn.gov/voters/vote-early-in-person/'
                  rel='noopener'
                  target='_blank'
                >vote early</a>
                if possible!</b></p>
            <p class='precinct-info'>
              Before you vote, it might be helpful to know a few things...
            </p>
          {{else}}
            <p class='precinct-info'>
              Hmm...
              <b><a href='{{gmaps}}' rel='noopener' target='_blank'>{{address}}</a></b>
              doesn't appear to be in Minneapolis!<br /><br />In any case, here's some info about your electoral
              boundaries!
            </p>
          {{/if}}
          <ul class='precinct-info'>
            <li><b>Precinct:</b> <span id='Precinct'>{{precinct.Precinct}}</span></li>
            <li><b>Park Board District:</b> <span id='Park'>{{precinct.Park}}</span></li>
            <li class='extra hidden'><b>U.S. Congressional District:</b>
              <span id='CongDist'>{{precinct.CongDist}}</span></li>
            <li class='extra hidden'><b>County:</b> <span id='County'>{{precinct.County}}</span></li>
            <li class='extra hidden'><b>County Commissioner District:</b>
              <span id='CtyComDist'>{{precinct.CtyComDist}}</span></li>
            <li class='extra hidden'><b>State Senate District:</b>
              <span id='MNSenDist'>{{precinct.MNSenDist}}</span></li>
            <li class='extra hidden'><b>State Legislative District:</b>
              <span id='MNLegDist'>{{precinct.MNLegDist}}</span></li>
            <li class='extra hidden'><b>State Judicial District:</b>
              <span id='Judicial'>{{precinct.Judicial}}</span></li>
            <li class='extra hidden'><b>Minor Civil Division (MCD):</b>
              <span id='MCDName'>{{precinct.MCDName}}</span></li>
            <li class='extra hidden'><b>Soil and Water District:</b>
              <span id='SoilAndWater'>{{precinct.SoilAndWater}}</span></li>
            <li class='extra hidden'><b>Hospital District:</b> <span id='Hospital'>{{precinct.Hospital}}</span></li>
            <li class='extra hidden'><b>County ID:</b> <span id='CountyID'>{{precinct.CountyID}}</span></li>
            <li class='extra hidden'><b>MCD Code:</b> <span id='MCDCode'>{{precinct.MCDCode}}</span></li>
            <li class='extra hidden'><b>Precinct Code:</b> <span id='PrecinctCode'>{{precinct.PrecinctCode}}</span></li>
            <li><a aria-expanded='false' onclick='toggleInfo(event)' href=''>Show More...</a></li>
          </ul>
        {{/if}}

        {{#if error}}
          <p class='precinct-info'>
            <!-- The server script passes error if the user submission can't be matched -->
            Hmm...
            <b>{{error.message}}</b>
            {{#if error.suggestion}}
              {{error.suggestion}}
            {{/if}}
          </p>
          {{#if error.addresses}}
            <ul class='precinct-info'>
              {{#each error.addresses}}
                <li><a href='{{this.href}}'>{{this.text}}</a></li>
              {{/each}}
            </ul>
          {{/if}}
        {{/if}}

        <div class='form-wrapper'>

          <!-- Our default paragraph/message -->
          {{#unless error}}
            {{#unless precinct}}
              <p>
                The open-source, API-backed poll finder that Steve Simon never built üíî
              </p><p>
                ‚ö†Ô∏è
                <a href='#faq'>Check out the FAQ</a>
                before diving in!
              </p>
            {{/unless}}
          {{/unless}}
          <form class='address-form' method='get'>
            <label for='address'>
              {{#if precinct}}
                Let's try another address!<br />
              {{else}}
                {{#if error}}
                  Let's try again!<br />
                {{else}}
                  What's your address?<br />
                {{/if}}
              {{/if}}
              <input id='address' name='address' required='required' type='text' value='{{error.query}}' />
            </label>
            <button type='submit'>Submit</button>
          </form>

          <form class='address-form' onsubmit='submitCurrentLocation(event)'>
            <label for='currentLocation'>
              Or, try looking it up for your current location!
              <i>(experimental)</i><br />
              <button id='currentLocation' type='submit'>Current Location</button>
            </label>
          </form>
          {{#unless precinct}}
            <br />Need an example?
            <a href='?example=go'>Click here!</a>
          {{/unless}}
        </div>

        <!-- FAQ -->
        <div class='faq-wrapper'>
          <h2 id='faq'>
            Frequently Asked Questions (F.A.Q.)
          </h2>
          <h3>What is this?</h3>
          <p>
            This is a tool that (mostly) helps you with one thing: finding your polling place (if you live in
            Minneapolis) and your voting precinct (if you live in Minnesota)!
          </p>
          <h3>Are there any limitations with this tool?</h3>
          <p>Yes. lol.
          </p>
          <p>First off, this relies on Google Maps for geocoding the data. Like any service, if you send garbage data to
            it, you'll receive garbage in return. In other words, you'll see the best results if you send complete
            street addresses (that actually exist!), with brownie points if you include a ZIP code.</p>
          <p>With any geocoder, the data tends to be less accurate in less populous areas. While it should work just
            fine for most parts of the state (provided you send it complete and valid addresses), take it with a grain
            of salt if you're outside of the Twin Cities Metro Area!
            <b>If you're ever unsure of the results you're getting,
              <a href='https://pollfinder.sos.state.mn.us/' rel='noopener' target='_blank'>the official poll finder</a>
              is your best bet.</b></p>
          <p><i>And lastly... this tool doesn't have any sample ballot data but long story short: #DontRankFrey and vote
              #NoYesYes ‚ù§Ô∏è</i></p>
          <h3>So this is cool and all but... the Minnesota Secretary of State
            <a href='https://pollfinder.sos.state.mn.us/' rel='noopener' target='_blank'>already does this</a>. Why are
            you?</h3>
          <p>It's true‚Äîthe Secretary of State (SOS) has done excellent work on these fronts and it serves us very well!
            However, the current system requires
            <b>a lot</b>
            of clicks to access all of that valuable information‚Äînot just access to your precinct and its corresponding
            polling place, but all of your electoral boundaries (Ward, County, Congressional Districts, etc.) and
            everything on your ballot.
          </p>
          <p>And what's worse, there's no discernable pattern to these URLs, meaning that all of this information is
            difficult to access at scale without significant resources. This makes it harder for grassroots campaigns to
            do their jobs, which in turn affects electoral turnout.</p>
          <p>This tool isn't intended to replace the SOS's system‚Äîit was built by a single person, I honestly couldn't
            do that if I tried! The purpose of this site is to demonstrate how modern web technologies can be used to
            create API-driven tools, which can (hopefully!) reduce some of the barriers to providing information for
            people. üå±
          </p>
          <h3>You mentioned that it's API-driven! How does that work?</h3>
          <p>You can retrieve a JSON version of data provided on the website by passing an
            <code>Accept</code>
            header in your request that specifies
            <code>application/json</code>. You can also pass a
            <code>format=json</code>
            query parameter (<a href='/?example=go&format=json' rel='noopener' target='_blank'>like this!</a>) and that
            should also do the trick.
          </p>
          <p>The markup on this webpage also includes a few hidden tricks for Google Sheets users to easily integrate
            this data into their workflows. You can grab the XPath selectors of certain fields on the page and then use
            formulas like these to import the data:</p>
          <ul>
            <li><code>=IMPORTXML("{{seo.url}}?address="&ENCODEURL("100 Main St"),"//*[@id='Precinct']")</code></li>
            <li><code>=IMPORTXML("https://mpls.vote?address="&ENCODEURL("100 Main St"),"//*[@id='address']")</code></li>
            <li><code>=IMPORTXML("{{seo.url}}?address="&ENCODEURL("100 Main St"),"//*[@id='mplsPollingPlace21']")</code></li>
          </ul>
          <p>API docs TBA! ü¶â</p>
          <h3>Do you have a privacy policy?</h3>
          <p>This is a humble proof-of-concept so it doesn't have a formal privacy policy, but this application does not
            load with any invasive analytics/tracking scripts, nor does it log any of the information you send. Oh, and
            the code is
            <a href='https://github.com/kanadgupta/mn-precinct-finder' rel='noopener' target='_blank'>fully open-source</a>
            if you'd like to take a look!</p>
          <p>The information you submit to the site via the query parameters (address information, geographic
            coordinates via the 'Current Location' button, etc.) is anonymously sent to the
            <a href='https://developers.google.com/maps/documentation/geocoding' rel='noopener' target='_blank'>Google
              Maps Geocoding API</a>
            so that information is subject to
            <a href='https://policies.google.com/privacy' rel='noopener' target='_blank'>their privacy policy</a>
            and
            <a href='https://policies.google.com/terms' rel='noopener' target='_blank'>their terms of use</a>. So don't,
            like, send your social security number through the form? This site won't see it or log it anywhere, but it's
            technically being sent to Google.
          </p>
        </div>

      </div>
    </div>
    {{! prettier-ignore }}
    <script>
      function submitCurrentLocation(e) {
        e.preventDefault();
        e.submitter.innerText = "Loading...";
        e.submitter.setAttribute('disabled', 'disabled');
        navigator.geolocation.getCurrentPosition(function(position) {
          const lat = position.coords.latitude;
          const long = position.coords.longitude;

          const queryString = new URLSearchParams({ lat, long });
          const pageUrl = '?' + queryString.toString();
          window.history.pushState('', '', pageUrl);

          window.location.reload();
          window.scrollTo(0, 0);
        });
      } 

      function toggleInfo(e) {
        e.preventDefault();
        // Toggle display of every hidden item
        document.querySelectorAll('li.extra').forEach(item => {
          item.classList.toggle('hidden');
        });
        // Update attributes on toggle element
        const isHidden = document.querySelector('li.extra').classList.contains('hidden');
        e.target.innerText = isHidden ? 'Show More...' : 'Show Less...';
        e.target.setAttribute('aria-expanded', !isHidden);
      }
    </script>
  </body>
</html>
